<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>AdminKatalog | VOKASI UB</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bbootstrap 4 -->
  <link rel="stylesheet" href="plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker.css">
  <!-- Date picker -->
  <link rel="stylesheet" href="datepicker/css/datepicker.css">
  <!-- summernote -->
  <link rel="stylesheet" href="plugins/summernote/summernote-bs4.css">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  <!-- Datepicker -->
  <link rel="stylesheet" href="datepicker/css/datepicker.min.css">
  
  <!-- Select2 -->
  <link rel="stylesheet" href="plugins/select2/css/select2.min.css">
  <link rel="stylesheet" href="plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">


  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
      </li>
    </ul>
    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a href="#" onclick="logout()" class="nav-link">
            Sign Out&nbsp; 
            <i class="fas fa-sign-out-alt"></i>
        </a>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->

 <!-- Main Sidebar Container -->
<aside class="main-sidebar sidebar-dark-primary elevation-4">
  <!-- Brand Logo -->
  <a href="index.php" class="brand-link">
    <img src="dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
         style="opacity: .8">
    <span class="brand-text font-weight-light">AdminKatalog</span>
  </a>

  <!-- Sidebar -->
  <div class="sidebar">

    <!-- Sidebar Menu -->
    <nav class="mt-2">
      <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
        
        <li class="nav-item">
          <a href="index.html" class="nav-link">
            <i class="nav-icon fas fa-database"></i>
            <p>
              Data Master
            </p>
          </a>
        </li>
        <li class="nav-item">
          <a href="index-penjualan.html" class="nav-link">
            <i class="nav-icon fas fa-chart-line"></i>
            <p>
            Transaksi Penjualan
            </p>
          </a>
        </li>
      </ul>
    </nav>
    <!-- /.sidebar-menu -->
  </div>
  <!-- /.sidebar -->
</aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h3><i class="fas fa-chart-line"></i> Transaksi Penjualan</h3>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item active"> Transaksi Penjualan</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
    <div class="card">
          <div class="card-header">
            <h3 class="card-title" style="margin-top:5px;"><i class="fas fa-list-ul"></i> Transaksi Penjualan</h3>
          </div>
          <!-- /.card-header -->
          <div class="card-body">
            <div class="row">
              <div class="col-lg-4" style="min-height:400px;">
                <div class="card card-primary">
                  <div class="card-header">
                    <h3 class="card-title">Item Pembelian</h3>
                  </div>
                  <form id="select-item-form">
                    <div class="card-body">
                      <div class="form-group">
                        <label>Pilih Item</label>
                        <select class="form-control select2" id="select-item" style="width: 100%;">

                        </select>
                      </div>
                    </div>  
                    <div class="card-footer">
                      <button type="submit" class="btn btn-primary float-right"><i class="fa fas fa-plus"></i> Tambah</button>
                    </div>
                  </form>
                </div>

              </div>
              <div class="col-lg-8" style="min-height:400px;">
                
              <table class="table">
                <thead>
                <tr>
                  <th width="40%">Nama Barang</th>
                  <th width="20%">Harga</th>
                  <th width="10%" class="text-center">Jumlah</th>
                  <th width="20%" class="text-right">Subtotal</th>
                  <th width="10%" class="text-center">Hapus</th>
                </tr>
                </thead>
                <tbody id="selected-item-body">
                  <tr id="total-row">
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td><strong>Total</strong></td>
                    <td class="text-right"><strong id="total-price">0</strong></td>
                    <td>&nbsp;</td>
                  </tr>
                  <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td><strong>Bayar</strong></td>
                    <td><input type="text" id="paid" name="paid" class="form-control text-right" value="0"></td>
                    <td>&nbsp;</td>
                  </tr>
                  <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td><strong>Kembali</strong></td>
                    <td><input type="text" name="change" id="change" class="form-control text-right" value="0" readonly></td>
                    <td>&nbsp;</td>
                  </tr>
                  <tr>
                    <td colspan="5">
                      <button type="submit" id="simpan" class="btn btn-primary float-right"><i class="fa fas fa-save"></i> Simpan</button>
                      <a href="index-penjualan.html" class="btn btn-default float-right mr-3"><i class="fa fas fa-times-circle"></i> Batal</a>
                    </td>
                  </tr>
                  </tbody>
              </table>
              </div>
              <!-- /.col-lg-8--> 
            </div> 
          </div>
          <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  <footer class="main-footer">
    <strong>Copyright &copy; 2021 <a href="http://vokasi.ub.ac.id">Vokasi UB</a>.</strong>
    All rights reserved.
  </footer>

</div>
<!-- ./wrapper -->


<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="plugins/jquery-ui/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Summernote -->
<script src="plugins/summernote/summernote-bs4.min.js"></script>
<!-- overlayScrollbars -->
<script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.js"></script>

<script src="dist/js/global.js"></script>
<!-- CKEditor -->
<script src="ckeditor/ckeditor.js"></script>
<!-- bootstrap datepicker -->
<script src="datepicker/js/bootstrap-datepicker.js"></script>
<script>
  //Date picker
  $('#datepicker-year').datepicker({
		format: "yyyy",
		orientation: "top auto",
    viewMode: "years", 
    minViewMode: "years",
    autoclose: true
  });

  document.onreadystatechange = async (e) => {
    if (document.readyState === 'complete') {
      const checkAuthUrl = "https://kasir-backend-ntb6iw2kdq-as.a.run.app/api/auth/me";

      const resCheckAuth = await fetch(checkAuthUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
          Authorization: "Bearer " + localStorage.getItem("katalog_token"),
        },
      });

      const resultCheckAuth = await resCheckAuth.json();

      if (resultCheckAuth.code == 401) {
        window.location.href = "login.html";
      }


      const url = new URL('https://kasir-backend-ntb6iw2kdq-as.a.run.app/api/items/all/get') 
      const res = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('katalog_token')
        }
      });

      const result = await res.json();

      items = result.data.items;

      items.forEach(item => {
        const selectItem = document.getElementById('select-item');

        const option = document.createElement('option');
        option.value = item.id;
        option.innerHTML = item.name;

        selectItem.appendChild(option);
      });

      const selectedItems = [];

      $('#select-item-form').submit(e => {
        const selectedId = document.getElementById('select-item').value;

        const selectedItem = items.find(item => item.id == selectedId);
        selectedItem.quantity = 1;

        if (selectedItems.find(item => item.id == selectedId)) {
          selectedItems.find(item => item.id == selectedId).quantity += 1;
        } else {
          selectedItems.push({
            id: selectedItem.id,
            name: selectedItem.name,
            price: selectedItem.price,
            quantity: 1
          });
        }

        const tableBody = document.getElementById('selected-item-body');

        const selectedTrs = tableBody.querySelectorAll('.selected-item');

        selectedTrs.forEach(tr => {
          tr.remove();
        });

        selectedItems.forEach(item => {
          const tr = document.createElement('tr');
          tr.className = 'selected-item';
          tr.id = item.id;

          const tdName = document.createElement('td');
          tdName.innerHTML = item.name;

          const tdPrice = document.createElement('td');
          tdPrice.innerHTML = item.price;

          const tdSubtotal = document.createElement('td');
          tdSubtotal.innerHTML = item.price * item.quantity;
          tdSubtotal.className = 'text-right';
          tdSubtotal.id = 'subtotal-' + item.id;

          const tdQuantity = document.createElement('td');
          tdQuantity.className = 'text-center';
          const inputQuantity = document.createElement('input');
          inputQuantity.type = 'number';
          inputQuantity.value = item.quantity;
          inputQuantity.className = 'form-control';
          inputQuantity.id = 'input-quantity-' + item.id;
          inputQuantity.onchange = e => {
            item.quantity = parseInt(e.target.value);

            calculateTotalPrice(selectedItems);
            calculateChange();
            calculateSubtotal(item.quantity, item.price, tdSubtotal);
          };
          tdQuantity.appendChild(inputQuantity);

          const tdAction = document.createElement('td');
          const btn = document.createElement('button');
          btn.className = 'btn btn-danger btn-xs';
          btn.innerHTML = '<i class="fas fa-trash"></i>';
          btn.onclick = e => {
            if (confirm('Are you sure?')) {
              const selectedItem = selectedItems.find(itm => itm.id == tr.id);
              selectedItems.splice(selectedItems.indexOf(selectedItem), 1);

              tr.remove();

              calculateTotalPrice(selectedItems);
              calculateChange();
            }
          };
          tdAction.appendChild(btn);
          tdAction.className = 'text-center';

          tr.appendChild(tdName);
          tr.appendChild(tdPrice);
          tr.appendChild(tdQuantity);
          tr.appendChild(tdSubtotal);
          tr.appendChild(tdAction);

          tableBody.insertBefore(tr, tableBody.firstChild);

          calculateTotalPrice(selectedItems);
          calculateChange();
        });

        e.preventDefault();
      });

      $('#paid').bind('keyup mouseup',e => {
        calculateChange();

        e.preventDefault();
      });

      $('#simpan').click(async e => {
        const paid = parseInt(document.getElementById('paid').value);
        const totalPrice = parseInt(document.getElementById('total-price').innerHTML);
        const change = parseInt(document.getElementById('change').value);
        
        if (!paid) {
          alert('Pembayaran harus diisi');
          return;
        }

        if (paid < totalPrice) {
          alert('Kurang bro uangnya');
          return;
        }

        if (confirm('Are you sure?')) {
          const paid = parseInt(document.getElementById('paid').value);
          const totalPrice = parseInt(document.getElementById('total-price').innerHTML);
          const change = parseInt(document.getElementById('change').value);

          const payload = {};

          payload.paid = paid;
          payload.change = change;
          payload.total_price = totalPrice;
          payload.transaction_items = [];

          selectedItems.forEach(item => {
            payload.transaction_items.push({
              item_id: item.id,
              quantity: item.quantity,
              subtotal: item.price * item.quantity
            });
          });

          const storeTxUrl = 'https://kasir-backend-ntb6iw2kdq-as.a.run.app/api/transactions'

          const res = await fetch(storeTxUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem('katalog_token')
            },
            body: JSON.stringify(payload)
          });

          const result = await res.json();

          if (result.code == 201) {
            alert('Success');
            window.location.href = 'index-penjualan.html';
          } else {
            alert('Failed');
          }
        }

        e.preventDefault();
      })
    }
  }

  const calculateTotalPrice = (selectedItems) => {
    const totalPrice = document.getElementById('total-price');
    let total = 0;

    selectedItems.forEach(item => {
      total += item.price * item.quantity;
    });

    totalPrice.innerHTML = total;
  }

  const calculateChange = () => {
    const totalPrice = document.getElementById('total-price');
    const cash = document.getElementById('paid');
    const change = document.getElementById('change');

    const total = parseInt(totalPrice.innerHTML);
    const cashValue = parseInt(cash.value);

    change.value = cashValue - total;
  }

  const calculateSubtotal = (qty, price, tdSubtotal) => {
    tdSubtotal.innerHTML = qty * price;
  }

  const deleteItem = (selectedItems, tr, selectedItemId) => {
    if (confirm('Are you sure?')) {
      selectedItems.forEach((item, index) => {
        if (item.id == selectedItemId) {
          selectedItems.splice(index, 1);
        }
      });

      tr.remove();

      calculateTotalPrice(selectedItems);
      calculateChange();
    }
  }

  const logout = () => {
    const url = 'https://kasir-backend-ntb6iw2kdq-as.a.run.app/api/auth/logout';

    const res = fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('katalog_token')
      }
    }).then((res) => res.json())
      .then((result) => {
        localStorage.removeItem('katalog_token');
        window.location.href = 'login.html';
      });
  }
</script>
<!-- Select2 -->
<script src="plugins/select2/js/select2.full.min.js"></script>
</body>
</html>
